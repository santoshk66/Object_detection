<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>This is title</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0; padding: 20px;
      color: #333;
    }
    h1 { font-size: 1.6em; margin-bottom: 0.3em; }
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    section { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, button { font-size: 0.9em; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #e5e7eb; }
    button:hover { background: #d1d5db; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.primary { background: #4a90e2; color: white; }
    button.primary:hover { background: #3a7bc8; }
    button.danger { background: #ef4444; color: white; }
    button.danger:hover { background: #dc2626; }
    button.success { background: #10b981; color: white; }
    button.success:hover { background: #059669; }
    .checkbox-list { max-height: 350px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; }
    pre { background: #f1f1f1; padding: 8px; border-radius: 6px; font-size: 0.85em; }
    .preview { width: 100%; height: 250px; background: #000; display: flex; justify-content: center; align-items: center; border-radius: 8px; overflow: hidden; }
    .preview-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .refresh-btn { background: #4a90e2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    .refresh-btn:hover { background: #3a7bc8; }
    .refresh-btn:active { transform: scale(0.98); }
    .counts-display { font-size: 1.1em; font-weight: bold; text-align: center; margin: 10px 0; }
    .count-in { color: #10b981; }
    .count-out { color: #ef4444; }
    .status-updates { margin-top: 10px; }
    .log-entry { font-size: 0.8em; padding: 2px 0; border-bottom: 1px solid #eee; }
    .log-entry:last-child { border-bottom: none; }
    .log-entry.error { color: #ef4444; }
    .log-entry.success { color: #10b981; }
    .log-entry.info { color: #3b82f6; }
    .reset-btn { background: #f59e0b; color: white; margin-top: 5px; }
    .reset-btn:hover { background: #d97706; }
    .update-status-btn { background: #8b5cf6; color: white; margin-left: 5px; }
    .update-status-btn:hover { background: #7c3aed; }
    label { display: block; margin-bottom: 5px; }
    input[type="range"] { width: 100%; }
    div[style*="margin-top"] { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>This is heading first.</h1>
  <p>This paragraph in short explains what is?</p>
  <div class="grid">
    <!-- Controls -->
    <section>
      <h2>Controls</h2>
      <label>RTSP / Source</label><br />
      <input id="rtsp" value="rtsp://192.168.0.8:554/..."/><br><br>
      <label>Line ratio (0.0 - 1.0)</label><br />
      <input id="lineRatio" type="range" min="0" max="1" step="0.01" value="0.5"/>
      <div>Current: <span id="lineRatioValue">0.5</span></div><br>
      <label><input type="checkbox" id="recordHourly" checked/> Record hourly</label><br><br>
      <label>Save path</label><br />
      <input id="savePath" value="./outputs" /><br><br>
      <button id="startBtn" class="primary success">Start Detection</button>
      <button id="stopBtn" class="danger" disabled>Stop Detection</button>
      <button id="resetCountsBtn" class="reset-btn" disabled>Reset Counts</button>
      <button id="saveCfgBtn" class="primary">Save Config</button>
      <div class="status-updates">
        <button id="updateStatusBtn" class="update-status-btn">Update Status</button>
      </div>
      <div style="margin-top:15px;">
        <div>Selected classes: <span id="selectedCount">0</span></div>
        <div class="counts-display">
          Counts: IN <span id="countIn" class="count-in">0</span> â€” OUT <span id="countOut" class="count-out">0</span>
        </div>
        <div id="lastUpdate" style="font-size:0.8em;color:#666;">Last updated: Never</div>
      </div>
    </section>
    <!-- COCO Classes -->
    <section>
      <h2>COCO Classes</h2>
      <div>
        <button id="selectAll" class="primary">Select All</button>
        <button id="clearAll" class="danger">Clear All</button>
      </div>
      <div id="classList" class="checkbox-list"></div>
    </section>
    <!-- Preview & Status -->
    <section>
      <div class="preview-controls">
        <h2>Live Preview</h2>
        <button id="refreshBtn" class="refresh-btn">Refresh Stream</button>
      </div>
      <p style="font-size:12px;color:#555;">If your backend exposes <code>/stream</code> as MJPEG, it will appear below.</p>
      <div class="preview">
        <img id="stream" src="/stream" alt="stream" style="max-width:100%;max-height:100%;">
      </div>
      <h3>Quick Status</h3>
      <pre id="statusBox">{}</pre>
      <h4>Recent Logs</h4>
      <div id="logContainer" style="max-height:150px;overflow-y:auto;border:1px solid #ddd;padding:5px;background:#f9f9f9;">
        <div class="log-entry">No logs yet...</div>
      </div>
    </section>
  </div>
  <script>
    const COCO_CLASSES = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light",
      "fire hydrant","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow",
      "elephant","bear","zebra","giraffe","backpack","umbrella","handbag","tie","suitcase","frisbee",
      "skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle",
      "wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange",
      "broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed",
      "dining table","toilet","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven",
      "toaster","sink","refrigerator","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
    const selected = new Set([0]);
    const classList = document.getElementById("classList");
    const selectedCount = document.getElementById("selectedCount");
    COCO_CLASSES.forEach((cls, i) => {
      const label = document.createElement("label");
      label.style.display = "block";
      label.innerHTML = `<input type="checkbox" data-id="${i}"> ${i}: ${cls}`;
      classList.appendChild(label);
    });
    function updateSelectedCount() { selectedCount.textContent = selected.size; }
    updateSelectedCount();
    classList.addEventListener("change", e => {
      const id = Number(e.target.dataset.id);
      if (e.target.checked) selected.add(id);
      else selected.delete(id);
      updateSelectedCount();
    });
    document.getElementById("selectAll").onclick = () => {
      selected.clear();
      COCO_CLASSES.forEach((_, i) => selected.add(i));
      document.querySelectorAll("#classList input").forEach(ch => ch.checked = true);
      updateSelectedCount();
    };
    document.getElementById("clearAll").onclick = () => {
      selected.clear();
      document.querySelectorAll("#classList input").forEach(ch => ch.checked = false);
      updateSelectedCount();
    };
    const lineRatioInput = document.getElementById("lineRatio");
    lineRatioInput.addEventListener("input", () => {
      document.getElementById("lineRatioValue").textContent = lineRatioInput.value;
    });
    let pollTimer = null;
    let logEntries = [];
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${timestamp}] ${message}`;
      const container = document.getElementById("logContainer");
      container.insertBefore(entry, container.firstChild);
      logEntries.unshift({ timestamp, message, type });
      if (logEntries.length > 10) {
        container.removeChild(container.lastChild);
        logEntries.pop();
      }
      // Remove the "No logs yet..." if logs exist
      const noLogs = container.querySelector('.log-entry:not(.info):not(.error):not(.success)');
      if (noLogs && logEntries.length > 0) {
        noLogs.remove();
      }
    }
    function startPolling() {
      if (pollTimer) return;
      pollTimer = setInterval(async () => {
        try {
          const res = await fetch("/api/counts");
          if (!res.ok) return;
          const data = await res.json();
          document.getElementById("countIn").textContent = data.in ?? 0;
          document.getElementById("countOut").textContent = data.out ?? 0;
          document.getElementById("lastUpdate").textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
          addLog(`Counts updated: IN=${data.in}, OUT=${data.out}`, 'info');
        } catch (e) {
          addLog(`Polling error: ${e.message}`, 'error');
        }
      }, 1000);
      addLog('Polling started', 'success');
    }
    function stopPolling() {
      clearInterval(pollTimer);
      pollTimer = null;
      addLog('Polling stopped', 'info');
    }
    async function sendStart() {
      const rtsp = document.getElementById("rtsp").value;
      const line_ratio = parseFloat(document.getElementById("lineRatio").value);
      const record_hourly = document.getElementById("recordHourly").checked;
      const save_path = document.getElementById("savePath").value;
      const classes = Array.from(selected).map(i => COCO_CLASSES[i]);
      const body = JSON.stringify({ classes, rtsp, line_ratio, record_hourly, save_path });
      try {
        const res = await fetch("/api/start", { method:"POST", headers:{ "Content-Type":"application/json" }, body });
        if (res.ok) {
          startPolling();
          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
          document.getElementById("resetCountsBtn").disabled = false;
          addLog('Detection started successfully', 'success');
        } else {
          const error = await res.text();
          addLog(`Failed to start: ${error}`, 'error');
          alert("Failed to start. Check backend logs.");
        }
      } catch (e) {
        addLog(`Start error: ${e.message}`, 'error');
      }
    }
    async function sendStop() {
      try {
        await fetch("/api/stop", { method:"POST" });
        stopPolling();
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("resetCountsBtn").disabled = true;
        addLog('Detection stopped', 'info');
      } catch (e) {
        addLog(`Stop error: ${e.message}`, 'error');
      }
    }
    async function resetCounts() {
      try {
        await fetch("/api/reset_counts", { method:"POST" });
        document.getElementById("countIn").textContent = 0;
        document.getElementById("countOut").textContent = 0;
        addLog('Counts reset to zero', 'success');
      } catch (e) {
        addLog(`Reset error: ${e.message}`, 'error');
      }
    }
    async function saveConfig() {
      const cfg = {
        RTSP: document.getElementById("rtsp").value,
        line: parseFloat(document.getElementById("lineRatio").value),
        recorded_save_every_hour: document.getElementById("recordHourly").checked,
        person_in: "left_to_right",
        person_out: "right_to_left",
        save_location: document.getElementById("savePath").value
      };
      try {
        const res = await fetch("/api/config", { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(cfg) });
        if (res.ok) {
          addLog('Config saved successfully', 'success');
          alert("Config saved");
        } else {
          const error = await res.text();
          addLog(`Config save failed: ${error}`, 'error');
          alert("Failed to save config");
        }
      } catch (e) {
        addLog(`Config error: ${e.message}`, 'error');
      }
    }
    async function updateStatus() {
      try {
        const res = await fetch("/api/status");
        if (res.ok) {
          const data = await res.json();
          document.getElementById("statusBox").textContent = JSON.stringify(data, null, 2);
          addLog('Status updated manually', 'info');
        } else {
          addLog('Failed to fetch status', 'error');
        }
      } catch (e) {
        addLog(`Status update error: ${e.message}`, 'error');
      }
    }
    // Refresh stream function
    function refreshStream() {
      const streamImg = document.getElementById("stream");
      const currentSrc = streamImg.src;
      // Force refresh by adding a timestamp parameter
      streamImg.src = "/stream?" + new Date().getTime();
      // If the image fails to load, revert to original source
      streamImg.onerror = function() {
        streamImg.src = currentSrc;
        addLog('Failed to refresh stream', 'error');
        alert("Failed to refresh stream. Please check if the backend is running.");
      };
      // Update status to show refresh time
      updateStatusBox({
        running: !!pollTimer,
        selected: Array.from(selected).slice(0, 8),
        lineRatio: lineRatioInput.value,
        lastRefresh: new Date().toLocaleTimeString()
      });
      addLog('Stream refreshed', 'info');
    }
    function updateStatusBox(data) {
      document.getElementById("statusBox").textContent = JSON.stringify(data, null, 2);
    }
    // Auto-update status box every 5 seconds
    setInterval(() => {
      updateStatusBox({
        running: !!pollTimer,
        selected: Array.from(selected).slice(0, 8),
        lineRatio: lineRatioInput.value,
        lastUpdate: new Date().toLocaleTimeString()
      });
    }, 5000);
    // Event listeners
    document.getElementById("startBtn").onclick = sendStart;
    document.getElementById("stopBtn").onclick = sendStop;
    document.getElementById("resetCountsBtn").onclick = resetCounts;
    document.getElementById("saveCfgBtn").onclick = saveConfig;
    document.getElementById("updateStatusBtn").onclick = updateStatus;
    document.getElementById("refreshBtn").onclick = refreshStream;
    // Initial status update
    updateStatus();
  </script>
</body>
</html>